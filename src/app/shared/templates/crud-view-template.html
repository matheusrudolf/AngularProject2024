<p-toolbar>

    <div class="p-toolbar-group-start">

        <p-button icon="pi pi-refresh" [text]="toolbarProps.minimalista" [rounded]="toolbarProps.btnCircular"
            [severity]="toolbarProps.minimalista ? null : 'primary'" [plain]="toolbarProps.minimalista" [raised]="toolbarProps.btnSombreado"
            size="small" pTooltip="Atualizar registros" styleClass="mr-1" (onClick)="recarregaDados()">
        </p-button>

        @if (toolbarProps.tabelaCrud) {

            <p-button icon="pi pi-plus" [text]="toolbarProps.minimalista" [rounded]="toolbarProps.btnCircular"
                [severity]="toolbarProps.minimalista ? null : 'success'" [plain]="toolbarProps.minimalista"
                [raised]="toolbarProps.btnSombreado" size="small" pTooltip="Novo registro" styleClass="mr-1"
                (onClick)="chamaModalNovoRegistro()">
            </p-button>

            <p-button icon="pi pi-trash" [text]="toolbarProps.minimalista" [rounded]="toolbarProps.btnCircular"
                [severity]="toolbarProps.minimalista ? null : 'danger'" [plain]="toolbarProps.minimalista"
                [raised]="toolbarProps.btnSombreado" size="small" pTooltip="Excluir registros" [disabled]="selecionados.length <= 0"
                styleClass="mr-1" (onClick)="removeRegistrosSelecionados()">
            </p-button>
        }

        <p-button icon="pi pi-filter" [text]="toolbarProps.minimalista" [rounded]="toolbarProps.btnCircular"
            [severity]="toolbarProps.minimalista ? null : 'secondary'" [plain]="toolbarProps.minimalista"
            [raised]="toolbarProps.btnSombreado" size="small" pTooltip="Definir filtros" styleClass="mr-1" (onClick)="chamaModalFiltros()">
        </p-button>

        @if (toolbarProps.apenasXlsx) {

            <p-splitButton icon="pi pi-file-export" [text]="toolbarProps.minimalista" [rounded]="toolbarProps.btnCircular"
                [raised]="toolbarProps.btnSombreado" outlined severity="secondary" [plain]="toolbarProps.minimalista" size="small"
                pTooltip="Exportadores" [model]="exportMenu" [menuStyle]="{ 'width': '320px' }"
                styleClass="border-none" />

        } @else {

            <p-splitButton icon="pi pi-file-export" [text]="toolbarProps.minimalista" [rounded]="toolbarProps.btnCircular"
                [raised]="toolbarProps.btnSombreado" outlined severity="secondary" [plain]="toolbarProps.minimalista" size="small"
                pTooltip="Exportadores" [model]="exportMenu" [menuStyle]="{ 'width': '320px' }"
                styleClass="border-none" />

        }

    </div>

    <div class="p-toolbar-group-end">

        <div style="max-width: 1200px;" class="mr-4">

            @if (tabelaProps.camposAgrupar.length <= 0) {

                <p class="font-normal text-sm">Nenhuma coluna agrupada. Botão direito na
                    coluna e selecione <b>Agrupar pela coluna</b>
                </p>

            }

            <div #groupBtn class="flex flex-row flex-wrap">

                <ng-container *ngFor="let col of tabelaProps.camposAgrupar">

                    <div class="group-field surface-400 border-round-xl text-xs font-bold select-none ml-2" (contextmenu)="onRightClick(col)"
                        pTooltip="Botão direito: Menu Contexo" showDelay="500" life="2000">
                        {{ col.header }}

                        <i #iconGroup class="text-xs cursor-pointer" [ngClass]="col.icone"
                            (click)="ordenacaoColunaAgrupada(col)">
                        </i>

                    </div>

                </ng-container>

            </div>

        </div>

        <input pInputText type="text" (input)="filtroGlobal($event)" placeholder="Buscar..." class="mr-2" />

        <p-button icon="pi pi-list-check" [text]="toolbarProps.minimalista" [rounded]="toolbarProps.btnCircular"
            [severity]="toolbarProps.minimalista ? 'secondary' : 'info'" [raised]="toolbarProps.btnSombreado"
            size="small" pTooltip="Seletor Colunas" styleClass="mr-1" (onClick)="exibeModalSeletorColunas($event)">
        </p-button>

    </div>

</p-toolbar>

<p-table #dt dataKey="id" stateStorage="local" [stateKey]="tabelaProps.nomeTabela" [value]="tabelaProps.dados"
    [columns]="tabelaProps.colunas" [columns]="colunasSelecionadas" responsiveLayout="stack" [rowHover]="true"
    [loading]="tabelaProps.carregando" [(selection)]="selecionados" selectionMode="multiple" [contextMenu]="cm"
    [rowGroupMode]="tabelaProps.grouping ? 'subheader' : null" [groupRowsBy]="tabelaProps.camposAgrupar"
    [reorderableColumns]="true" [resizableColumns]="true" [globalFilterFields]="filtrosGlobais"
    [paginator]="tabelaProps.dados.length >= 10" [rows]="10" [first]="0" [rowsPerPageOptions]="[10, 25, 50, 100]"
    [showCurrentPageReport]="true" currentPageReportTemplate="Exibindo {first} à {last} de {totalRecords} registros"
    styleClass="p-datatable-sm p-datatable-gridlines p-datatable-striped shadow-3">

    <ng-template pTemplate="colgroup" let-columns>

        <colgroup>

            <col style="width: 2rem">

        </colgroup>

        @for (col of columns; track $index) {

            <colgroup *ngIf="!col.grouped">

                <col [style.width]="col.width">

            </colgroup>

        }

    </ng-template>

    <ng-template pTemplate="header" let-columns>

        <tr>
            <th>
                <p-tableHeaderCheckbox />
            </th>

            @for (col of columns; track $index) {

                @if (col.field !== 'edit') {

                    <th [pContextMenuRow]="col.field" [pSortableColumn]="col.field"
                        (contextmenu)="onRightClick(col)" pTooltip="Botão direito: Menu Contexo" showDelay="500" life="2000"
                        pReorderableColumn pResizableColumn [hidden]="col.grouped">
                        {{ col.header }}

                        <p-sortIcon [field]="col.field"></p-sortIcon>

                    </th>

                } @else {

                    <th class="text-center">{{ col.header }}</th>

                }

            }

        </tr>

    </ng-template>

    <ng-template pTemplate="groupheader" let-rowData let-rowIndex="rowIndex" let-expanded="expanded">

        <ng-container *ngFor="let campo of tabelaProps.camposAgrupar">
            <tr
                *ngIf="rowIndex == 0 || resolveFieldData(rowData, campo.field) !== resolveFieldData(tabelaProps.dados[rowIndex - 1], campo.field)">

                <td [attr.colspan]="tabelaProps.colunas.length">

                    <button type="button" pButton [pRowToggler]="rowData"
                        class="p-button-text p-button-rounded p-button-plain mr-2"
                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
                    </button>

                    <span>{{ resolveFieldData(rowData, campo.field) }}</span>

                </td>

            </tr>

            <tr
                *ngIf="rowIndex == 0 || resolveFieldData(rowData, campo.field) !== resolveFieldData(tabelaProps.dados[rowIndex - 1], campo.field)">

                <td [attr.colspan]="tabelaProps.colunas.length">

                    <span>{{ resolveFieldData(rowData, campo.field) }}</span>

                </td>

            </tr>
        </ng-container>

    </ng-template>

    <ng-template pTemplate="body" let-rowData let-columns="columns">

        <tr [ngClass]="{'linha-selecionada': dt.isSelected(rowData)}">

            <td>

                <p-tableCheckbox [value]=" rowData"></p-tableCheckbox>

            </td>

            @for (col of columns; track $index) {

                @if (col.field !== 'edit') {

                    <td [class]="col.alignment" (click)="selecaoLinhaPorClique(rowData)" [hidden]="col.grouped">
                        {{ col.type ? col.type.transform(rowData[col.field], col.arg) : rowData[col.field] }}
                    </td>

                } @else {

                    <td class="flex justify-content-center">

                        @if (tabelaProps.acoesCustom) {

                            @for (btn of tabelaProps.btnAcoesCustom; track $index) {

                                <p-button [icon]="rowData.icon ? rowData.icon : btn.icon" [rounded]="btn.btnCirculo" [raised]="btn.btnSombreado" size="small"
                                    [text]="btn.btnText" [pTooltip]="btn.tooltip" [severity]="btn.btnCor" [styleClass]="btn.class"
                                    (onClick)="btn.evento(rowData)">
                                </p-button>
                            }

                        } @else {

                            <p-button icon="pi pi-file" [text]="toolbarProps.minimalista" [rounded]="true"
                                [severity]="this.toolbarProps.minimalista ? null : 'secondary'" [plain]="toolbarProps.minimalista"
                                [raised]="toolbarProps.btnSombreado" size="small" pTooltip="Ver registro" styleClass="mr-1"
                                (onClick)="chamaModalVisualizacao(rowData)">
                            </p-button>

                            <p-button icon="pi pi-pencil" [text]="toolbarProps.minimalista" [rounded]="true"
                                [severity]="toolbarProps.minimalista ? null : 'info'" [plain]="toolbarProps.minimalista"
                                [raised]="toolbarProps.btnSombreado" size="small" pTooltip="Alterar registro" styleClass="mr-1"
                                (onClick)="chamaModalAlteracao(rowData)">
                            </p-button>

                            <p-button icon="pi pi-trash" [text]="toolbarProps.minimalista" [rounded]="true"
                                [severity]="toolbarProps.minimalista ? null : 'danger'" [plain]="toolbarProps.minimalista"
                                [raised]="toolbarProps.btnSombreado" size="small" pTooltip="Excluir registro"
                                (onClick)="removeRegistro(rowData)">
                            </p-button>

                        }

                    </td>
                }
            }
        </tr>

    </ng-template>

    <ng-template pTemplate="emptymessage">

        <tr>

            <td class="w-full border-1 surface-border surface-50 p-4" [attr.colspan]="tabelaProps.colunas.length + 1">

                <p class="text-center">Nenhum registro encontrado...</p>

            </td>

        </tr>

    </ng-template>

</p-table>

<p-contextMenu #cm [target]="groupBtn" [model]="menuContextoTabela" [style]="{'width': '250px'}" styleClass="shadow-3" />

<p-dialog #chooser header="Selecione as Colunas" [(visible)]="seletorColunas.visivel" [modal]="false"
    [draggable]="false" [resizable]="false" [style]="seletorColunas.estilo" styleClass="shadow-3">

    <ng-template pTemplate="content">

        <p-listbox [options]="constroiColunasSeletor()" [(ngModel)]="colunasSelecionadas" optionLabel="header" [checkbox]="true"
            [multiple]="true" [filter]="true" filterPlaceHolder="Buscar..." (onChange)="SelecionaTodasColunas($event)" />

    </ng-template>

</p-dialog>
